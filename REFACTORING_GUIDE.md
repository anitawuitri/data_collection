# 🏗️ AMD GPU 監控系統重構指南

## 📋 重構概述

本文件說明 AMD GPU 監控系統的重構過程，將原有的單一 Python 文件和 Shell 腳本重構為模組化、可維護的現代架構。

### 🎯 重構目標

1. **模組化架構**：清晰的分層設計，分離關注點
2. **可維護性**：易於理解、修改和擴展的程式碼
3. **可測試性**：全面的測試覆蓋和 CI/CD 支援
4. **現代化工具**：使用現代 Python 工具和最佳實踐
5. **容器化部署**：支援 Docker 容器化部署
6. **向後兼容**：保持與現有功能的完全相容性

## 🏛️ 新架構設計

### 目錄結構

```
data_collection/
├── src/                          # 新的模組化程式碼
│   ├── core/                     # 核心業務邏輯
│   │   ├── collectors/           # 數據收集器
│   │   │   ├── base_collector.py # 抽象基礎類
│   │   │   ├── netdata_collector.py # Netdata API 收集器
│   │   │   └── management_collector.py # 管理 API 收集器
│   │   ├── models/               # 領域模型
│   │   │   ├── gpu.py           # GPU 模型
│   │   │   ├── user.py          # 使用者模型
│   │   │   └── node.py          # 節點模型
│   │   └── services/            # 業務服務
│   ├── infrastructure/          # 基礎設施層
│   │   ├── config/             # 配置管理
│   │   │   └── settings.py     # 統一配置
│   │   ├── storage/            # 存儲層
│   │   └── external/           # 外部服務整合
│   └── cli/                    # 命令列介面
│       ├── main.py            # CLI 主程式
│       └── commands/          # 命令實現
├── tests/                      # 測試套件
│   ├── unit/                  # 單元測試
│   ├── integration/           # 整合測試
│   └── conftest.py           # 測試配置
├── pyproject.toml             # 現代專案配置
├── Dockerfile                 # 容器化配置
├── docker-compose.yml         # 服務編排
├── setup.sh                   # 快速安裝腳本
└── legacy/                    # 原有程式碼 (保留參考)
```

### 🔧 核心組件

#### 1. 配置管理 (`src/infrastructure/config/`)

統一的配置管理系統，支援環境變數和預設值：

```python
@dataclass
class AppConfig:
    data_dir: Path
    plots_dir: Path
    nodes: List[NodeConfig]
    gpu: GPUConfig
    api: APIConfig
    
    @classmethod
    def from_env(cls) -> 'AppConfig':
        # 從環境變數載入配置
        pass
```

#### 2. 數據收集器 (`src/core/collectors/`)

抽象化的數據收集器架構：

- **BaseCollector**: 抽象基礎類，定義共同介面
- **NetdataCollector**: 從 Netdata API 收集 GPU 指標
- **ManagementCollector**: 從管理系統收集使用者資訊

#### 3. 領域模型 (`src/core/models/`)

清晰的領域模型定義：

- **GPU**: GPU 實體和指標數據
- **User**: 使用者資訊和任務資料
- **Node**: 節點資訊和 GPU 集合

#### 4. CLI 介面 (`src/cli/`)

現代化的命令列介面使用 Click 框架：

```bash
gpu-monitor collect daily --date 2025-09-15
gpu-monitor query user paslab_openai 2025-09-15
gpu-monitor visualize trends 2025-09-01 2025-09-15
```

## 🔄 遷移策略

### 第一階段：基礎架構建立

1. ✅ 建立新的目錄結構
2. ✅ 創建配置管理系統
3. ✅ 實現抽象數據收集器
4. ✅ 定義領域模型

### 第二階段：功能遷移

1. 🔄 遷移數據收集邏輯
2. 🔄 遷移使用者查詢功能
3. 🔄 整合視覺化系統
4. 🔄 實現 CLI 命令

### 第三階段：測試和部署

1. ✅ 建立測試框架
2. 🔄 編寫單元測試和整合測試
3. ✅ 容器化部署配置
4. 🔄 CI/CD 流水線設定

## 🛠️ 使用指南

### 快速開始

1. **安裝依賴**：
   ```bash
   ./setup.sh install
   ```

2. **配置環境**：
   ```bash
   cp .env.example .env
   # 編輯 .env 文件，填入 API Token
   ```

3. **執行測試**：
   ```bash
   ./setup.sh test
   ```

4. **數據收集**：
   ```bash
   poetry run gpu-monitor collect daily
   ```

5. **查詢使用者**：
   ```bash
   poetry run gpu-monitor query user paslab_openai 2025-09-15
   ```

### Docker 部署

1. **啟動服務**：
   ```bash
   ./setup.sh docker
   ```

2. **查看日誌**：
   ```bash
   docker-compose logs -f
   ```

3. **執行命令**：
   ```bash
   docker-compose exec gpu-monitor gpu-monitor --help
   ```

## 🔍 主要改進

### 1. 程式碼結構

- **分層架構**：清晰的業務邏輯分層
- **模組化設計**：可重用的組件
- **依賴注入**：鬆散耦合的設計
- **類型註解**：完整的類型提示

### 2. 錯誤處理

- **統一異常處理**：標準化的錯誤處理機制
- **詳細錯誤資訊**：更好的錯誤診斷
- **優雅降級**：部分失敗時的容錯機制

### 3. 效能優化

- **異步處理**：並發數據收集
- **快取機制**：減少重複 API 調用
- **批次處理**：高效的數據處理
- **連接池**：優化網路連接

### 4. 可觀測性

- **結構化日誌**：統一的日誌格式
- **指標監控**：系統運行指標
- **健康檢查**：服務健康狀態監控
- **追踪功能**：請求追踪和除錯

## 📊 相容性說明

### 與舊版本相容

- **資料格式**：完全相容現有 CSV 格式
- **目錄結構**：保持相同的資料目錄結構
- **API 介面**：向後相容的 API 設計
- **配置檔案**：支援現有配置格式

### 遷移路徑

1. **並行運行**：新舊版本可以並行運行
2. **逐步遷移**：逐個功能進行遷移
3. **資料備份**：自動備份現有資料
4. **回滾機制**：支援快速回滾到舊版本

## 🧪 測試策略

### 測試覆蓋

- **單元測試**：核心邏輯測試 (>90% 覆蓋率)
- **整合測試**：組件整合測試
- **端到端測試**：完整工作流測試
- **效能測試**：負載和壓力測試

### 測試工具

- **pytest**：測試框架
- **pytest-asyncio**：異步測試支援
- **pytest-cov**：測試覆蓋率
- **mock/fixture**：測試模擬

## 📈 效能改進

### 數據收集效能

- **並發收集**：多節點同時收集
- **批次處理**：減少 I/O 操作
- **連接重用**：HTTP 連接池
- **數據壓縮**：減少網路傳輸

### 查詢效能

- **索引優化**：快速數據查找
- **快取策略**：減少重複計算
- **分頁支援**：大數據集處理
- **異步查詢**：非阻塞查詢

## 🔐 安全性增強

### API 安全

- **Token 管理**：安全的 API Token 處理
- **請求驗證**：API 請求驗證
- **速率限制**：防止 API 濫用
- **錯誤隱藏**：不洩漏敏感資訊

### 資料安全

- **敏感資料保護**：使用者資訊保護
- **存取控制**：基於角色的存取控制
- **資料加密**：靜態和傳輸加密
- **稽核日誌**：操作追踪記錄

## 🚀 未來規劃

### 短期目標

1. 完成所有功能遷移
2. 建立完整測試覆蓋
3. 優化效能和穩定性
4. 完善文件和教學

### 中期目標

1. Web 介面開發
2. 實時監控儀表板
3. 警報和通知系統
4. API 服務化

### 長期目標

1. 機器學習預測
2. 自動化運維
3. 多雲部署支援
4. 開源社區建設

## 💡 開發最佳實踐

### 程式碼風格

- **PEP 8**: Python 程式碼風格指南
- **Type Hints**: 完整的類型註解
- **Docstrings**: 詳細的文件字符串
- **Black/isort**: 自動格式化工具

### 版本控制

- **Git Flow**: 標準化的分支策略
- **Commit 規範**: 語義化提交訊息
- **Code Review**: 程式碼審查流程
- **CI/CD**: 自動化測試和部署

### 文件維護

- **API 文件**: 自動生成的 API 文件
- **使用者指南**: 詳細的使用說明
- **開發指南**: 開發環境設定
- **架構圖**: 系統架構說明

---

這個重構將 AMD GPU 監控系統升級為現代化、可維護、可擴展的企業級解決方案，同時保持與現有系統的完全相容性。