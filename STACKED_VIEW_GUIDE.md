# 🔥 各節點 GPU 使用率堆疊區域圖功能說明

## 📊 功能概述

各節點 GPU 使用率堆疊區域圖是一個專為資源管理設計的新視覺化功能，它按節點分層顯示 GPU 使用率累積情況，讓管理員能夠清楚地看到每個節點對整體GPU負載的貢獻程度。

## ✨ 功能特點

### 🎯 核心功能
- **節點分層顯示**: 按 colab-gpu1 到 colab-gpu4 分層堆疊顯示
- **累積視角**: 顯示各節點 GPU 使用率的累積效果
- **使用者資訊整合**: 可選顯示各節點活躍使用者
- **專用配色方案**: 每個節點使用專用顏色，便於識別

### 📈 視覺化特色
- **堆疊區域圖**: 使用填充區域顯示各節點的使用率貢獻
- **統計資訊框**: 顯示總體統計和各節點平均使用率
- **使用者標籤**: 在圖例中顯示各節點的活躍使用者
- **高解析度輸出**: 300 DPI，適合報告和印刷

### 🆚 與其他視圖的區別

| 視圖類型 | 著重點 | 適用場景 |
|----------|--------|----------|
| **節點對比趨勢圖** | 各節點平均使用率對比 | 節點性能比較 |
| **堆疊區域圖** | 各節點對總負載的貢獻 | 資源配置分析 |
| **全GPU累積視圖** | 所有GPU的總體使用 | 整體資源監控 |

## 🎯 應用場景

### 🏢 容量規劃
- **負載分佈分析**: 了解各節點的負載分佈是否均勻
- **擴容決策**: 確定哪些節點需要增加GPU資源
- **資源重配置**: 評估節點間資源重新分配的可能性

### 👥 使用者管理
- **使用者分佈**: 了解使用者在不同節點的分佈情況
- **資源偏好**: 識別使用者對特定節點的偏好
- **負載平衡**: 引導使用者使用負載較輕的節點

### 📈 性能分析
- **節點效能**: 比較各節點的GPU利用效率
- **瓶須識別**: 快速發現性能瓶頸節點
- **趨勢追蹤**: 監控各節點負載的長期變化

## 🛠️ 使用方法

### 命令列使用

```bash
# 基本使用
./run_gpu_visualization.sh stacked 2025-08-15 2025-08-17

# 查看使用說明
./run_gpu_visualization.sh --help

# 包含在快速生成中（自動包含堆疊視圖）
./run_gpu_visualization.sh quick 2025-08-15 2025-08-17
```

### Python API 使用

```python
from visualization.quick_gpu_trend_plots import quick_nodes_stacked_utilization

# 基本使用（包含使用者資訊）
plot_path = quick_nodes_stacked_utilization(
    start_date='2025-08-15',
    end_date='2025-08-17',
    data_dir='./data',
    plots_dir='./plots',
    show_users=True
)

# 簡潔版本（不含使用者資訊）
plot_path = quick_nodes_stacked_utilization(
    start_date='2025-08-15',
    end_date='2025-08-17',
    show_users=False
)
```

### 快速測試

```bash
# 執行測試腳本
python3 test_stacked_view.py

# 生成示範圖表
./run_gpu_visualization.sh stacked $(date -d '7 days ago' +%Y-%m-%d) $(date +%Y-%m-%d)
```

## 📊 圖表解讀

### 圖表結構
```
標題: 各節點 GPU 使用率累積視圖（堆疊區域圖）
期間: YYYY-MM-DD 至 YYYY-MM-DD

總活躍使用者數: X 人

Y軸: 累積 GPU 使用率 (%)
X軸: 日期

圖例: 
- colab-gpu1 (使用者1, 使用者2, ...)
- colab-gpu2 (使用者3, 使用者4, ...)
- colab-gpu3 (使用者5等3人)
- colab-gpu4

統計資訊框:
- 最大累積使用率: XX.X%
- 平均累積使用率: XX.X%
- colab-gpu1: XX.X%
- colab-gpu2: XX.X%
- colab-gpu3: XX.X%
- colab-gpu4: XX.X%
```

### 解讀技巧

#### 👁️ 視覺分析
1. **堆疊高度** - 總高度代表所有節點的累積使用率
2. **區域大小** - 每個顏色區域的大小代表該節點的貢獻
3. **顏色分佈** - 觀察哪個節點（顏色）占主導地位
4. **時間變化** - 查看不同時段各節點貢獻的變化

#### 📈 數據分析
1. **峰值時段** - 找出使用率最高的時間段
2. **負載分佈** - 評估各節點負載是否均勻
3. **使用模式** - 識別使用者的活動模式
4. **資源效率** - 比較各節點的資源利用效率

## 🔧 配置選項

### 函數參數

| 參數 | 類型 | 默認值 | 說明 |
|------|------|--------|------|
| `start_date` | str | 必需 | 開始日期 (YYYY-MM-DD) |
| `end_date` | str | 必需 | 結束日期 (YYYY-MM-DD) |
| `data_dir` | str | "../data" | 數據目錄路徑 |
| `plots_dir` | str | "../plots" | 輸出目錄路徑 |
| `show_users` | bool | True | 是否顯示使用者資訊 |

### 視覺化設定
- **節點顏色**: 
  - colab-gpu1: 藍色 (#1f77b4)
  - colab-gpu2: 橙色 (#ff7f0e)
  - colab-gpu3: 綠色 (#2ca02c)
  - colab-gpu4: 紅色 (#d62728)
- **圖表大小**: 18×12 英寸（含使用者資訊）或 18×10 英寸
- **解析度**: 300 DPI
- **透明度**: 80% (alpha=0.8)

## 💡 使用建議

### 📅 時間範圍選擇
- **日常監控**: 1-3 天，查看短期使用模式
- **週期分析**: 1-2 週，了解週期性變化
- **月度報告**: 1 個月，進行月度資源使用評估
- **季度規劃**: 2-3 個月，支援長期容量規劃

### 👥 使用者資訊顯示
- **管理場景**: 啟用使用者資訊，進行使用者管理
- **報告場景**: 根據受眾敏感度決定是否顯示使用者
- **公開展示**: 關閉使用者資訊，專注於技術指標

### 📊 與其他圖表搭配
1. **搭配節點對比圖** - 詳細比較各節點性能
2. **搭配熱力圖** - 查看具體GPU的使用分佈
3. **搭配VRAM監控** - 全面了解資源使用情況
4. **搭配時間序列圖** - 深入分析特定時段

## 🔧 故障排除

### 常見問題

#### 1. 圖表生成失敗
```bash
# 檢查數據完整性
ls -la data/*/2025-08-*/average_*.csv

# 測試函數
python3 test_stacked_view.py

# 檢查環境
source .venv/bin/activate
python3 -c "import pandas, matplotlib, numpy; print('環境正常')"
```

#### 2. 使用者資訊缺失
- **原因**: 使用舊版數據收集器或API連接問題
- **解決**: 使用Python版數據收集器重新收集數據

#### 3. 圖表顯示異常
- **檢查字體**: `cd visualization && python3 test_fonts.py`
- **檢查數據格式**: 確認CSV檔案包含正確的欄位

#### 4. 性能問題
- **大數據量**: 選擇較短的時間範圍
- **記憶體不足**: 關閉不必要的程序

## 📋 更新日誌

### v1.0.0 (2025-08-18)
- ✅ 初始版本發布
- ✅ 支援各節點堆疊區域圖視覺化
- ✅ 整合使用者資訊顯示
- ✅ 專用節點配色方案
- ✅ 統計資訊面板
- ✅ 命令列介面支援
- ✅ 整合到快速生成系統
- ✅ 完整測試覆蓋

## 🤝 技術實現

### 核心演算法
1. **數據收集**: 讀取各節點的daily average CSV檔案
2. **數據處理**: 計算每個節點的日平均GPU使用率
3. **使用者解析**: 提取並整理使用者資訊
4. **視覺化渲染**: 使用matplotlib的fill_between繪製堆疊區域
5. **統計計算**: 計算累積統計資訊和各節點貢獻

### 資料流程
```
數據目錄 → CSV讀取 → 數據清洗 → 使用者提取 → 
堆疊計算 → 視覺化渲染 → 統計添加 → 圖表輸出
```

## 🚀 未來計劃

### 短期改進 (1-2 週)
- [ ] 添加節點排序選項
- [ ] 支援自定義顏色主題
- [ ] 添加動態閾值線

### 中期發展 (1-2 個月)
- [ ] 支援小時級時間間隔
- [ ] 添加節點故障標記
- [ ] 支援多指標同時顯示

### 長期願景 (3-6 個月)
- [ ] 交互式Web版本
- [ ] 實時數據更新
- [ ] 異常檢測功能

---

*功能版本: v1.0.0*  
*更新日期: 2025-08-18*  
*狀態: ✅ 生產就緒*