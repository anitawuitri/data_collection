# VRAM 堆疊區域圖視圖指南

## 功能概述

新增的 VRAM 堆疊區域圖視圖專門用於顯示各節點 VRAM（Video Random Access Memory，顯示記憶體）使用率的累積情況。這個視圖提供了一個清晰的方式來觀察整個集群中各節點 VRAM 資源的分佈和使用模式。

## 主要特色

### 📊 視覺化特點
- **堆疊區域設計**：各節點的 VRAM 使用率以不同顏色的區域堆疊顯示
- **累積視圖**：顯示所有節點 VRAM 使用率的總和趨勢
- **色彩編碼**：每個節點使用不同顏色區分
  - colab-gpu1: 紅色 (#FF6B6B)
  - colab-gpu2: 青色 (#4ECDC4)
  - colab-gpu3: 藍色 (#45B7D1)
  - colab-gpu4: 綠色 (#96CEB4)

### 🔍 數據分析
- **節點貢獻分析**：清楚顯示各節點對總體 VRAM 使用的貢獻
- **時間趨勢追蹤**：觀察 VRAM 使用率隨時間的變化
- **峰值識別**：輕鬆識別 VRAM 使用高峰期
- **資源分佈**：了解 VRAM 負載在各節點間的分佈情況

### 👥 使用者資訊
- **活躍使用者顯示**：在圖例中顯示最後一天的活躍使用者
- **使用者統計**：顯示總活躍使用者數量
- **使用者過濾**：只統計 VRAM 使用率 > 1% 的使用者

### 📈 統計面板
- **即時統計**：顯示最大和平均累積 VRAM 使用率
- **節點分析**：各節點的平均 VRAM 貢獻百分比
- **視覺優化**：淺青色統計框，避免與圖例重疊

## 使用方法

### 命令行使用
```bash
# 基本用法
./run_gpu_visualization.sh vram-stacked [開始日期] [結束日期]

# 範例
./run_gpu_visualization.sh vram-stacked 2025-08-15 2025-08-17
./run_gpu_visualization.sh vram-stacked 2025-08-11 2025-08-17
```

### Python 函數調用
```python
from quick_gpu_trend_plots import quick_nodes_vram_stacked_utilization

# 生成 VRAM 堆疊圖
result = quick_nodes_vram_stacked_utilization(
    start_date='2025-08-15', 
    end_date='2025-08-17',
    data_dir='data',
    plots_dir='plots',
    show_users=True
)
```

## 輸出檔案

### 檔案格式
- **檔名格式**：`nodes_vram_stacked_utilization_YYYY-MM-DD_to_YYYY-MM-DD.png`
- **解析度**：300 DPI，適合印刷和展示
- **尺寸**：15x10 英寸，提供充足的顯示空間
- **檔案大小**：約 270-280 KB

### 範例檔案
```
plots/nodes_vram_stacked_utilization_2025-08-15_to_2025-08-17.png
plots/nodes_vram_stacked_utilization_2025-08-11_to_2025-08-17.png
```

## 數據需求

### 數據格式
需要包含 VRAM 使用率欄位的 CSV 檔案：
- `平均VRAM使用率(%)` 或 `vram` 欄位
- `使用者` 欄位（用於使用者資訊顯示）
- `GPU編號` 欄位（用於過濾非全部平均資料）

### 數據來源
```
data/
├── colab-gpu1/
│   └── 2025-08-17/
│       └── average_2025-08-17.csv
├── colab-gpu2/
│   └── 2025-08-17/
│       └── average_2025-08-17.csv
└── ...
```

## 功能優化

### 布局優化
- **圖例位置**：右上角，使用 `bbox_to_anchor=(0.98, 0.98)`
- **統計框位置**：左側 75% 高度處，避免重疊
- **框架設計**：圖例有白色背景和灰色邊框
- **陰影效果**：圖例添加陰影增強視覺層次

### 錯誤處理
- **檔案缺失**：優雅處理缺失的數據檔案
- **數據格式**：自動處理數值轉換錯誤
- **空白數據**：正確處理 NaN 和空值
- **異常捕獲**：完整的異常處理機制

## 應用場景

### 📊 系統監控
- **資源規劃**：評估 VRAM 資源分配和利用效率
- **容量規劃**：預測未來 VRAM 需求
- **負載平衡**：識別需要負載平衡的節點
- **性能優化**：找出 VRAM 使用瓶頸

### 🔍 問題診斷
- **記憶體洩漏**：識別異常的 VRAM 使用模式
- **資源爭搶**：分析多使用者環境中的資源競爭
- **使用者行為**：了解不同使用者的 VRAM 使用習慣
- **系統健康**：評估整體系統的 VRAM 健康狀況

### 📈 趨勢分析
- **使用模式**：分析 VRAM 使用的時間模式
- **季節性變化**：識別週期性的使用變化
- **成長趨勢**：追蹤 VRAM 需求的成長
- **效能基準**：建立 VRAM 使用的基準線

## 技術實現

### 核心函數
```python
def quick_nodes_vram_stacked_utilization(start_date, end_date, data_dir, plots_dir, show_users=True):
    """
    生成各節點 VRAM 使用率累積堆疊區域圖
    
    特色功能:
    - 自動數據收集和處理
    - 智能使用者資訊整合  
    - 統計分析和視覺化
    - 優化的圖表佈局
    """
```

### 數據處理流程
1. **日期範圍生成**：創建指定期間的日期序列
2. **節點數據收集**：遍歷各節點收集 VRAM 數據
3. **使用者資訊提取**：收集活躍使用者資訊
4. **數據聚合**：計算節點級平均 VRAM 使用率
5. **堆疊繪圖**：使用 matplotlib 創建堆疊區域圖
6. **統計計算**：生成詳細統計資訊
7. **圖表優化**：應用佈局和樣式優化
8. **檔案輸出**：保存高品質圖表檔案

## 與現有功能的整合

### 命令對比
```bash
# GPU 使用率堆疊圖
./run_gpu_visualization.sh stacked 2025-08-15 2025-08-17

# VRAM 使用率堆疊圖  
./run_gpu_visualization.sh vram-stacked 2025-08-15 2025-08-17
```

### 功能互補
- **GPU 堆疊圖**：關注計算資源使用
- **VRAM 堆疊圖**：關注記憶體資源使用
- **組合分析**：兩者結合提供完整的資源視圖

## 未來擴展

### 計劃功能
- **互動式圖表**：支援滑鼠懸停顯示詳細資訊
- **自定義顏色主題**：支援用戶定義色彩方案
- **小時級分析**：支援更精細的時間粒度
- **導出功能**：支援導出為 PDF 和 SVG 格式
- **即時監控**：支援即時數據更新和顯示

### 整合計劃
- **儀表板整合**：整合到 Web 儀表板中
- **警告系統**：設定 VRAM 使用率警告閾值
- **API 接口**：提供 REST API 接口
- **自動報告**：定期生成 VRAM 使用報告

---

**文檔版本**: v1.0  
**創建日期**: 2025-08-18  
**更新日期**: 2025-08-18  
**狀態**: ✅ 已實現並測試通過